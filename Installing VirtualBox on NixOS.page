if you have a working nix os system but you feel the urge to use
virtualbox to have several guests like .... other nix os machines for
example, then this will help you.

what needs to be in /etc/nixos/configuration.nix
------------------------------------------------

     boot.kernelModules = [
       "cpufreq_powersave" "fuse"
       # at least add this 3 modules there and don't delete the other entries!
       "vboxdrv" "vboxnetadp" "vboxnetflt"
     ];

     boot.extraModulePackages = [
       pkgs.linuxPackages.virtualbox
     ];

     environment.systemPackages = [
       pkgs.linuxPackages.virtualbox
     ];

after editing your configuration.nix do
---------------------------------------

     nixos-rebuild switch

if everything went well:

     reboot

after the reboot
----------------

type:

     VirtualBox

error messages
--------------

### missing kernel modules

if you get this error message (like this), something went wrong:

     "/dev/vboxdrv does not exist. Load the kernel module then try again."

### kvm kernel module is loaded

     VirtualBox can't operate in VMX root mode. Please disable the KVM kernel extension, recompile your kernel and reboot (VERR_VMX_IN_VMX_ROOT_MODE). 

solution:

     rmmod kvm-intel
     rmmod kvm-amd

then start the 'virtual machine' again and it should work

### adding a new network using VirtualBox

VirtualBox -\> File -\> Preferences -\> (in tab) Network -\> (click) Add
host-only network

I get this error message:

     Failed to create the host-only network interface.
     Failed to execute 'VBoxNetAdpCtl add' (exit status: 768).
     
     Result Code: 
     NS_ERROR_FAILURE (0x80004005)
     Component: 
     HostNetworkInterface
     Interface: 
     IHostNetworkInterface {ce6fae58-7642-4102-b5db-c9005c2320a8}

Solution: none so far!

links
-----

<https://svn.nixos.org/repos/nix/configurations/trunk/misc/nicolas.b.pierron/vinon.nix>

