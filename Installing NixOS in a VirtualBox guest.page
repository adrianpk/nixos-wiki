Installing NixOS On VirtualBox
------------------------------

Using NixOS with VirtualBox on OS X.

-   Download the NixOs iso for 32 bit from <http://nixos.org>
-   Add a New Machine in VirtualBox with OS Type "Ubuntu"
-   Base Memory Size: 768 MB or first \`export
    GC\_INITIAL\_HEAP\_SIZE=1\` before installing
-   New Hard Disk of 8 GB
-   Mount the CD-Rom with the NixOs iso (by clicking on CD/DVD-ROM)
-   Click on Settings / Advanced (or possibly System / Processor) and
    enable PAE/NX
-   Networking: select "Attached to: NAT". Change host-interface to
    "en1: Airport".
-   Now you can install nix using the nixos manual:

     $ fdisk /dev/sda (create a full partition, don't skip this step, example commands for quick setup: n,p,1,w)
     $ mke2fs -j -L nixos /dev/sda1 (idem)
     $ mount LABEL=nixos /mnt
     $ mkdir -p /mnt/etc/nixos
     $ nixos-hardware-scan > /mnt/etc/nixos/configuration.nix (for quick setup overwrite configuration.nix completely with example below)
     $ nano /mnt/etc/nixos/configuration.nix

(add the fileSystems. this is what my final config looks like:)

     {pkgs, config, ...}:
     {
       boot = {
         loader.grub.device = "/dev/sda";
         initrd.kernelModules = [  "ata_piix" ];
      };

      fileSystems = [
         { mountPoint = "/";
           label = "nixos";
         }
       ];
       nix.maxJobs = 1;
       services = {
         openssh.enable =true;
         virtualbox.enable = true;
         xserver.videoDriver = "virtualbox";
       };
       # If you disable kde4, set environment.systemPackages instead.
       environment.kdePackages = [
         config.boot.kernelPackages.virtualboxGuestAdditions
       ];
     }

Now we're ready to install!

     $ nixos-install
     $ reboot

In order to access the host's clipboard and automatically resize the
screen add this line to a script which runs once after login (I use
xmonad/xterm and .bash\_login seems early enough):

     VBoxClient-all

Now you got a working nixos system. However, you can't conveniently log
in to ssh this way, so you'll need to set up port-forwarding. Doing that
is explained on this site, all you have to do is create a script named
"vbox-tunnel" that contains the following lines:

     #!/bin/bash
     cd /Applications/VirtualBox.app/Contents/MacOS/
     ./VBoxManage setextradata "$1" "VBoxInternal/Devices/pcnet/0/LUN#0/Config/$2/Protocol" TCP
     ./VBoxManage setextradata "$1" "VBoxInternal/Devices/pcnet/0/LUN#0/Config/$2/GuestPort" $3
     ./VBoxManage setextradata "$1" "VBoxInternal/Devices/pcnet/0/LUN#0/Config/$2/HostPort" $4

Now execute the script:

     vbox-tunnel Nix sshtunnel 22 2222

You should be able to log in to Nix now by running
`ssh -p2222 localhost` in your OS X Terminal. Enjoy!

Alternative (independent of virtual network card chosen for the guest):

     VBoxManage modifyvm "Nix" --natpf1 "sshtunnel,tcp,,2222,,22"

As before, you are now able to log in to Nix by running
`ssh -p2222 localhost` in your terminal.

