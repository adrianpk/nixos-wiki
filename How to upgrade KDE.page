[[edit](/w/index.php?title=How_to_upgrade_KDE&action=edit&section=1 "Edit section: How it works")] How it works
---------------------------------------------------------------------------------------------------------------

Everything for building KDE lives under pkgs/desktops/kde\*. The
default.nix uses kde-package/default.nix to generate the expressions for
all the programs, and that in turn uses metadata that's generated by the
kde-manifest.sh script.

[[edit](/w/index.php?title=How_to_upgrade_KDE&action=edit&section=2 "Edit section: Minor Upgrades")] Minor Upgrades
-------------------------------------------------------------------------------------------------------------------

Please fill this in if you know how.

[[edit](/w/index.php?title=How_to_upgrade_KDE&action=edit&section=3 "Edit section: Major Upgrades")] Major Upgrades
-------------------------------------------------------------------------------------------------------------------

Upgrading a major KDE version is quite a task, here are the steps I
followed to go from KDE 4.12 to KDE 4.13.

### [[edit](/w/index.php?title=How_to_upgrade_KDE&action=edit&section=4 "Edit section: Initial setup")] Initial setup

First off, download all the source files for the release to somewhere,
let that run while you do the next steps:

    $ mkdir ~/kde-src
    $ cd ~/kde-src
    $ wget --recursive --no-clobber --continue --no-parent --accept=html,xz http://download.kde.org/stable/4.13.2/src/

Clone the nixpkgs git repository. I find it easiest to do development on
the last available commit of the unstable nixpkgs binary channel, so run
a `nix-channel --update` and make a new branch from there:

    $ nix-channel --update
    downloading Nix expressions from `http://releases.nixos.org/nixos/unstable/nixos-14.10pre44881.f7c7282/nixexprs.tar.xz'...
    [...]
    $ git checkout f7c7282
    [...]
    HEAD is now at f7c7282... Merge pull request #2979 from bluescreen303/idris
    $ git checkout -b kde-4.13.2
    Switched to a new branch 'kde-4.13.2'

### [[edit](/w/index.php?title=How_to_upgrade_KDE&action=edit&section=5 "Edit section: Update KDE metadata")] Update KDE metadata

Copy the old 4.12 expressions so that any changes you make are visible
as diffs instead of everything being new files, and add update
kde\_next:

    $ cd pkgs/desktops/
    $ cp -r kde-4.12 kde-4.13
    $ vi ../top-level/all-packages.nix 
    $ git diff
    diff --git a/pkgs/top-level/all-packages.nix b/pkgs/top-level/all-packages.nix
    index 4aa330a..857ac5d 100644
    --- a/pkgs/top-level/all-packages.nix
    +++ b/pkgs/top-level/all-packages.nix
    @@ -10362,7 +10362,7 @@ let

       kde4 = recurseIntoAttrs pkgs.kde412;

    -  kde4_next = recurseIntoAttrs( lib.lowPrioSet pkgs.kde412 );
    +  kde4_next = recurseIntoAttrs( lib.lowPrioSet pkgs.kde413 );

       kde412 = kdePackagesFor (pkgs.kde412 // {
           eigen = eigen2;
    @@ -10370,6 +10370,12 @@ let
           libcanberra = libcanberra_kde;
         }) ../desktops/kde-4.12;

    +  kde413 = kdePackagesFor (pkgs.kde413 // {
    +      eigen = eigen2;
    +      libusb = libusb1;
    +      libcanberra = libcanberra_kde;
    +    }) ../desktops/kde-4.13;
    +
       kdePackagesFor = self: dir:
         let callPackageOrig = callPackage; in 
         let
    $ git add kde-4.13/
    $ git commit -a -m "kde: Copy 4.12 to 4.13 as a base"
    [kde-4.13.2 8fe3bd5] kde: Copy 4.12 to 4.13 as a base
     189 files changed, 3164 insertions(+), 2 deletions(-)
     create mode 100644 pkgs/desktops/kde-4.13/applications/kate.nix
    [...]

Now, we'll upgrade the KDE expressions to the new source versions we
downloaded. There is a script to help with it, and it also includes a
line to store the files in the Nix store but that's commented out. I
uncommented it before running it. Also note that it needs xsltproc,
which I got with `nix-env -i libxslt`.

On a special note just for this version, kde-workspace doesn't have the
same version as the rest of the release, so I changed the script to
parse all .tar.xz files instead of just the ones with the detected
release version, and I made it store the projects file in the source
dir.

    $ cd kde-4.13/kde-package/
    $ nix-shell -p libxslt --command "bash kde-manifest.sh ~/kde-src/download.kde.org/stable/4.13.2/src/"
    Detected release 4.13.2
    amor.. 0lrgvi8r2b4z3yp8xdjydf41gm84cxzr90flswb9a0vrsvshkkx1 (kdetoys)
    /nix/store/fx1bbcp3vjccx6ki8ikixdzxm8a18sb7-amor-4.13.2.tar.xz
    [...]
    Writing 4.13.2.nix
    Printing modules splitted by upstream
    kdemultimedia:Called print_sane kdemultimedia
    Called print_sane audiocd-kio
    Sane version is audiocd_kio
    [...]
    $ vi ../default.nix
    $ git diff ../default.nix
    [...]
    -{ callPackage, callPackageOrig, stdenv, qt48, release ? "4.12.4" }:
    +{ callPackage, callPackageOrig, stdenv, qt48, release ? "4.13.2" }:
     
     let
    -  branch = "4.12";
    +  branch = "4.13";

### [[edit](/w/index.php?title=How_to_upgrade_KDE&action=edit&section=6 "Edit section: Update the localization metadata")] Update the localization metadata

    $ cd ../l10n/
    $ bash l10n-manifest.sh ~/kde-src/download.kde.org/stable/4.13.2/src/kde-l10n/
    Detected release 4.13.2
    ar.. /nix/store/pg4qq0y6f968frp35kywz84g4l2bk9j2-kde-l10n-ar-4.13.2.tar.xz
    [...]
    $ cd -

### [[edit](/w/index.php?title=How_to_upgrade_KDE&action=edit&section=7 "Edit section: Upgrade the expressions")] Upgrade the expressions

Now eyeball the differences between the versions. In my case a few new
packages appeared so I created expressions for those. The kdelibs
package also needed to be added to the kdelibs module or there was an
infinite recursion.

    $ diff -u 4*
    $ vi 4.13.2.nix
    $ rm 4.12.4.nix

Then, try to make building KDE work and commit when it makes sense. When
you push the commits to the repository, make sure each intermediate step
evaluates, squash commits if needed.

